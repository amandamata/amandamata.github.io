<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>queue on amandaintech</title>
    <link>/tags/queue/</link>
    <description>amandaintech (queue)</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <lastBuildDate>Wed, 22 Feb 2023 07:19:25 -0300</lastBuildDate>
    
    <atom:link href="/tags/queue/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>Implementing a sqs publisher and consumer using dotnet</title>
      <link>/post/queue-csharp-sqs/</link>
      <pubDate>Wed, 22 Feb 2023 07:19:25 -0300</pubDate>
      
      <guid>/post/queue-csharp-sqs/</guid>
      <description>&lt;p&gt;In this &lt;a href=&#34;https://amandamata.github.io/queue&#34;&gt;post&lt;/a&gt;, I pass an introduction to a queue and how to use it. Now I gonna explain how to implement an sqs consumer and publisher using c# dotnet.
&lt;br/&gt;&lt;/p&gt;
&lt;h4 id=&#34;sqs&#34; &gt;
&lt;div&gt;
    &lt;a href=&#34;#sqs&#34;&gt;
        ###
    &lt;/a&gt;
    SQS
&lt;/div&gt;
&lt;/h4&gt;
&lt;p&gt;What is SQS?&lt;/p&gt;
&lt;p&gt;SQS (Simple Queue Service) is an Amazon service that lets you send, store, and receive messages between software components at any volume, without losing messages or requiring other services to be available.&lt;/p&gt;
&lt;p&gt;The best part is free, actually to pay for this service you gonna need to send over 1 million requests per month then amazon is going to bill you.&lt;/p&gt;
&lt;p&gt;To start, it&amp;rsquo;s necessary to create an account in &lt;a href=&#34;https://aws.amazon.com/&#34;&gt;aws&lt;/a&gt; and go to &lt;a href=&#34;https://console.aws.amazon.com&#34;&gt;console&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In the console area, type SQS in search and enter the first option Simple Queue Service.
Click on Create queue, add a name to the queue and go to the end of the page and click Create queue. You can change the default values, but for now, all the settings are ok.
&lt;br/&gt;&lt;/p&gt;
&lt;h4 id=&#34;aws-command-line-interface&#34; &gt;
&lt;div&gt;
    &lt;a href=&#34;#aws-command-line-interface&#34;&gt;
        ###
    &lt;/a&gt;
    AWS Command Line Interface
&lt;/div&gt;
&lt;/h4&gt;
&lt;p&gt;The AWS Command Line Interface allows us to make changes directly from the console without the need to access the AWS console.
For example, if we need to list the buckets:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;aws s3api list-buckets
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;To be able to do that we need to install the cli, the tutorial for Windows, Linux, and macOS is &lt;a href=&#34;https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;After the installation, it&amp;rsquo;s necessary to authenticate your machine against aws.&lt;/p&gt;
&lt;p&gt;In aws console, click in your name and go to Security Credentials, there, you need to create an Access Key.&lt;/p&gt;
&lt;p&gt;In your console you gonna type:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;aws configure
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then pass your access key and token when requested.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Important, in the aws console you have a region, mine is us-east-1, you can see yours by checking on url: https://&lt;em&gt;&lt;strong&gt;us-east-1&lt;/strong&gt;&lt;/em&gt;.console.aws.amazon.com/&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;That region needs to be passed during aws configuration, to be able to access aws features locally.&lt;/p&gt;
&lt;p&gt;After the configuration, you&amp;rsquo;re gonna able to execute the list buckets.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;aws s3api list-buckets
&lt;/code&gt;&lt;/pre&gt;&lt;br/&gt;
&lt;h4 id=&#34;publisher&#34; &gt;
&lt;div&gt;
    &lt;a href=&#34;#publisher&#34;&gt;
        ###
    &lt;/a&gt;
    Publisher
&lt;/div&gt;
&lt;/h4&gt;
&lt;p&gt;What is a publisher?&lt;/p&gt;
&lt;p&gt;A publisher it&amp;rsquo;s a service that gonna get the information that something changes and sends to the queue a request.
In the example used in the queue post, the publisher is inside the API, and after a new user was created the request was sent to the queue.&lt;/p&gt;
&lt;p&gt;So with everything configured, it&amp;rsquo;s time to create the publisher.&lt;/p&gt;
&lt;p&gt;In order to simplify, the example here it&amp;rsquo;s gonna be only the publisher, then you can take the implementation and use it in your API.&lt;/p&gt;
&lt;p&gt;We&amp;rsquo;re gonna use a Console App&lt;/p&gt;
&lt;p&gt;Create a new folder:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;mkdir publisher
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Go inside the folder:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;cd publisher
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Create the project:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;dotnet new console
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It&amp;rsquo;s necessary a model:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;public class CustomerCreated
{
  public Guid Id { get; init; }
  public string FullName { get; init; }
  public string Email { get; init; }
  public DateTime DateOfBirth { get; init; }
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;And install the &lt;a href=&#34;https://www.nuget.org/packages/AWSSDK.SQS&#34;&gt;AWS SDK&lt;/a&gt;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;dotnet add package AWSSDK.SQS --version 3.7.100.78
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After that, in the Program we need to create a request and send it:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;using System.Text.Json;
using Amazon.SQS;
using Amazon.SQS.Model;

var sqsCLient = new AmazonSQSClient();

var customer = new CustomerCreated
{
  Id = Guid.NewGuid(),
  FullName = &amp;#34;Amanda Mata&amp;#34;,
  Email = &amp;#34;email@email.com&amp;#34;,
  DateOfBirth = new DateTime(1996, 06, 18)
};

var queueUrlResponse = await sqsCLient.GetQueueUrlAsync(&amp;#34;customers&amp;#34;);

var sendMessageRequest = new SendMessageRequest
{
  QueueUrl = queueUrlResponse.QueueUrl, 
  MessageBody = JsonSerializer.Serialize(customer),
  MessageAttributes = new Dictionary&amp;lt;string, MessageAttributeValue&amp;gt;
  {
      {
          &amp;#34;MessageType&amp;#34;, new MessageAttributeValue
          {
              DataType = &amp;#34;String&amp;#34;, 
              StringValue = nameof(CustomerCreated)
          }
      }
  }
};

var response = await sqsCLient.SendMessageAsync(sendMessageRequest);

Console.WriteLine();
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;In the sqsCLient.GetQueueUrlAsync(&amp;ldquo;customers&amp;rdquo;) I used &amp;ldquo;customers&amp;rdquo; cuz that is the name of my queue&lt;/p&gt;
&lt;/blockquote&gt;
&lt;br/&gt;
&lt;h4 id=&#34;consumer&#34; &gt;
&lt;div&gt;
    &lt;a href=&#34;#consumer&#34;&gt;
        ###
    &lt;/a&gt;
    Consumer
&lt;/div&gt;
&lt;/h4&gt;
&lt;p&gt;What it&amp;rsquo;s a consumer?&lt;/p&gt;
&lt;p&gt;A consumer it&amp;rsquo;s the service that will be listening the queue.&lt;/p&gt;
&lt;p&gt;We&amp;rsquo;re gonna use a Console App&lt;/p&gt;
&lt;p&gt;Create a new folder:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;mkdir consumer
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Go inside the folder:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;cd consumer
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Create the project:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;dotnet new console
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It&amp;rsquo;s necessary a model:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;public class CustomerCreated
{
  public Guid Id { get; init; }
  public string FullName { get; init; }
  public string Email { get; init; }
  public DateTime DateOfBirth { get; init; }
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;And install the &lt;a href=&#34;https://www.nuget.org/packages/AWSSDK.SQS&#34;&gt;AWS SDK&lt;/a&gt;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;dotnet add package AWSSDK.SQS --version 3.7.100.78
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After that, in the Program we need to receive the request:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;using Amazon.SQS;
using Amazon.SQS.Model;
	 
var cts = new CancellationTokenSource();
var sqsCLient = new AmazonSQSClient();
var queueUrlResponse = await sqsCLient.GetQueueUrlAsync(&amp;#34;customers&amp;#34;);
var receiveMessageRequest = new ReceiveMessageRequest
{
  QueueUrl = queueUrlResponse.QueueUrl,
  AttributeNames = new List&amp;lt;string&amp;gt;{ &amp;#34;All&amp;#34; },
  MessageAttributeNames = new List&amp;lt;string&amp;gt;{ &amp;#34;All&amp;#34; }
};
	 
while(!cts.IsCancellationRequested)
{
  var response = await sqsCLient.ReceiveMessageAsync(receiveMessageRequest, cts.Token);
  response.Messages.ForEach(async message =&amp;gt; {
    Console.WriteLine($&amp;#34;Message Id: { message.MessageId }&amp;#34;);
    Console.WriteLine($&amp;#34;Message Body: { message.Body }&amp;#34;);
    await sqsCLient.DeleteMessageAsync(queueUrlResponse.QueueUrl, message.ReceiptHandle);
  });

  await Task.Delay(3000);
}

Console.WriteLine();
&lt;/code&gt;&lt;/pre&gt;&lt;br/&gt;
&lt;p&gt;Now the publisher and the consumer It&amp;rsquo;s created, you can pull for messages inside the aws console, but just running the publisher and the consumer you&amp;rsquo;re gonna be able to see the sending and receiving messages.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;I create this post for my studying purpose, the learnings I posted here were driven by the &lt;a href=&#34;https://nickchapsas.com/p/cloud-fundamentals-aws-services-for-c-developers&#34;&gt;Cloud Fundamentals: AWS Services for C# Developers course&lt;/a&gt;.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Application of queue</title>
      <link>/post/queue/</link>
      <pubDate>Wed, 08 Feb 2023 00:00:00 +0000</pubDate>
      
      <guid>/post/queue/</guid>
      <description>&lt;p&gt;What is a queue?
A queue is a collection of entities that are maintained in a sequence and can be modified by the addition of entities at one end of the sequence and the removal of entities from the other end of sequence. Wikipedia&lt;/p&gt;
&lt;p&gt;Imagine that we have a user&amp;rsquo;s API.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://amandamata.github.io/img/queue2.png&#34; alt=&#34;queue2&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can create users in the system and then retrieve them back, maybe update and maybe delete them, send an email to the user, and also make a request to another API.
In this scenario, if when sending an email and that email fails, that entire request fails and it&amp;rsquo;s necessary to make another request to have the entire process done.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://amandamata.github.io/img/queue1.png&#34; alt=&#34;queue1&#34;&gt;&lt;/p&gt;
&lt;p&gt;But that does not need to be like this, cuz sending an email and making the request to another API for this flow it&amp;rsquo;s not crucial and could be done later async.&lt;/p&gt;
&lt;p&gt;Here enter the queue concept.
We could instead of making all those things sync, make only the crucial sync and the rest async by adding in a queue what could be done later.&lt;/p&gt;
&lt;p&gt;To get this done it&amp;rsquo;s necessary to have a consumer service, that will be listening to the queue and do something with the information in the queue, like sending an email.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://amandamata.github.io/img/queue3.png&#34; alt=&#34;queue3&#34;&gt;&lt;/p&gt;
&lt;p&gt;That makes your system more resilient if something fails to process, it&amp;rsquo;s going back to the queue and then will be reprocessed later.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
